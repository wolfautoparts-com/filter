<?php
use Wolf\Filter\Block\Navigation as B;
$b = $block; /** @var B $block */ /** @var B $b */
$config = $b->getConfigJson();
$categoriesByLevel = $config['categoriesByLevel'];
list($selectedCarContStyle, $selectedCarContStyle1) =
	!df_action_is('catalog_category_view', 'catalogsearch_result_index', 'cms_noroute_index')
	? ['', ''] : ['style="display: block;"', 'style="display: none;"']
;
?>
<div class="block" style="margin-bottom: 0; min-height: 40px;">
	<div class="garage-selected-car-cont" <?= $selectedCarContStyle; ?>>
		Selected Car: &nbsp;&nbsp;
		<?php if($config['customer_garage_uri'] && !$config['customer_garage_is_empty']):?>
			<a class="garage-selected-car-link" href="<?= $config['customer_garage_uri']; ?>" style="text-transform: capitalize;"><?= $config['customer_garage_uri_name']; ?></a>
		<?php else:?>
			<a class="garage-selected-car-link" href="#"><?= __('No Car Selected'); ?></a>
		<?php endif; ?>
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<button class="btn-link change-car-btn">Change Car</button>
	</div>
	<div class="block nav-categoryfilters garage-cont" <?= $selectedCarContStyle1; ?>>
		<div class="block-title title-row">
			<div><strong><span><?= $b['title'] ?></span></strong></div>
			<div>
				<div class="loading-message">
					<?= $b['loading_message'] ?: 'Loading...' ?>
				</div>
			</div>
		</div>
		<div style="garage-block">
			<div class="garage-block-cars">
				<form action="" name="change-car-form" id="change-car" method="post" class="row change-car-form"></form>
			</div>
			<div class="garage-block-filters">
				<form action="" name="category-form" id="add-new-car" method="post" class="row category-form">
					<div id="cd-<?= $b->getNameInLayout() ?>" class="block-content row">
						<?php
						$lastSelect = false;
						$levels = $b['levels'];
						for ($l = 0; $l < $levels; $l++) {
							if ($l == ($levels - 1)) {
								$lastSelect = true;
							}
							?>
							<div class="    select-outer<?php if ($lastSelect) echo ' select-outer-last'; ?>">
								<?php if ($b->getLabelsEmbedded() == 'outside' && $label = $b->getSelectLabel($l)): ?>
									<label><?= $label ?></label>
								<?php endif ?>
								<?php $j = $l + 1; ?>

								<select dataId="<?= $j; ?>"
										id="<?= $b->getNameInLayout() ?><?= $j; ?>"
										class="category-filter-select">
									<?php if ($b->getLabelsEmbedded() == 'embedded' && $label = $b->getSelectLabel($l)): ?>
										<option value=""><?= $label ?></option>
									<?php else: ?>
										<option value="">Please Select</option>
									<?php endif ?>
									<?php
									if ($l == 0) { // only fill first select
										if (isset($categoriesByLevel[$l])) {
											foreach ($categoriesByLevel[$l] as $cat) {
												?>
												<option value="<?= $cat['id']; ?>"
														dataUrl="<?= $cat['url']; ?>">
													<?= $cat['name']; ?>
												</option>
												<?php
											}
										}
									}
									?>
								</select>
							</div>
						<?php } ?>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>
<div class="clearfix"></div>
<script type="text/javascript">
	requirejs(['jquery', 'categoryFilter'], function (jQuery) {
		var categoryFilters = {
			'labelembedded': '<?= $b->getLabelsEmbedded(); ?>',
			'levels': '<?= $b['levels'] ?>',
			'nameInLayout': '<?= $b->getNameInLayout() ?>',
			'url': '<?= $b->getBaseUrl(); ?>categoryfinder/index/change/'
		};
		var mainDivId = '#cd-<?= $b->getNameInLayout() ?>';
		jQuery(mainDivId).categoryfilter(categoryFilters);
	});
</script>